name: Check Kruidvat Website (Playwright)

on:
  workflow_dispatch:

jobs:
  test-browser:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Playwright
      run: |
        npm init -y
        npm install @playwright/test
        npx playwright install --with-deps

    - name: Create Playwright test
      run: |
        cat << 'EOF' > test-kruidvat.js
        const { chromium, devices } = require('@playwright/test');

        (async () => {
          // Emulazione browser desktop reale
          const iPhone = devices['Desktop Chrome'];

          const browser = await chromium.launch({
            headless: true,
            args: [
              "--disable-blink-features=AutomationControlled",
              "--no-sandbox"
            ]
          });

          const context = await browser.newContext({
            ...iPhone,
            locale: "nl-NL",
            geolocation: { longitude: 5.1214, latitude: 52.0907 }, // Paesi Bassi
            permissions: ["geolocation"],
          });

          const page = await context.newPage();

          try {
            console.log("Opening Kruidvat...");
            await page.goto("https://www.kruidvat.nl", {
              waitUntil: "networkidle",
              timeout: 60000
            });

            const title = await page.title();
            console.log("Page title:", title);

            // Screenshot per debug
            await page.screenshot({ path: "kruidvat.png", fullPage: true });

            // Salva HTML risultante
            const html = await page.content();
            const fs = require('fs');
            fs.writeFileSync("kruidvat.html", html);

            console.log("Saved screenshot and HTML.");

          } catch (err) {
            console.error("Error:", err);
          }

          await browser.close();
        })();
        EOF

    - name: Run Playwright script
      run: node test-kruidvat.js

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kruidvat-debug
        path: |
          kruidvat.png
          kruidvat.html
