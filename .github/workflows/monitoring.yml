name: Check Kruidvat Website

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # ogni ora (opzionale)

jobs:
  test-browser:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Puppeteer
      run: |
        npm init -y
        npm install puppeteer

    - name: Run browser simulation
      run: |
        cat << 'EOF' > test.js
        const puppeteer = require('puppeteer');

        (async () => {
          const browser = await puppeteer.launch({
            headless: true,
            args: [
              "--no-sandbox",
              "--disable-setuid-sandbox",
              "--disable-blink-features=AutomationControlled"
            ]
          });

          const page = await browser.newPage();

          // Spoof browser fingerprint (aiuta contro alcuni bot manager)
          await page.setUserAgent(
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122 Safari/537.36"
          );

          await page.setExtraHTTPHeaders({
            "accept-language": "en-US,en;q=0.9"
          });

          try {
            await page.goto("https://www.kruidvat.nl", {
              waitUntil: "networkidle2",
              timeout: 45000
            });

            console.log("Page title:", await page.title());

            // Screenshot per debug
            await page.screenshot({ path: "kruidvat.png" });

            console.log("Screenshot saved: kruidvat.png");
          } catch (e) {
            console.error("Error opening page:", e);
          }

          await browser.close();
        })();
        EOF

        node test.js

    - name: Upload screenshot
      uses: actions/upload-artifact@v4
      with:
        name: kruidvat-screenshot
        path: kruidvat.png
