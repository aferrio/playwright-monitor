name: Check Kruidvat Website (Advanced Playwright)

on:
  workflow_dispatch:

jobs:
  test-browser:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install Playwright
      run: |
        npm init -y
        npm install playwright playwright-extra playwright-extra-plugin-stealth
        npx playwright install --with-deps

    - name: Create Playwright script
      run: |
        cat << 'EOF' > test-kruidvat.js
        const { chromium } = require('playwright-extra');
        const stealth = require('playwright-extra-plugin-stealth')();

        chromium.use(stealth);

        (async () => {
          const browser = await chromium.launch({
            headless: true,
            args: [
              "--no-sandbox",
              "--disable-setuid-sandbox",

              // ***** FORCE HTTP/1 *****
              "--disable-http2",
              "--disable-features=NetworkService",
              "--disable-features=AllowHTTP2",

              // ***** ANTI-DETETCTION *****
              "--disable-blink-features=AutomationControlled",
              "--disable-web-security",
              "--disable-features=IsolateOrigins,site-per-process"
            ]
          });

          const context = await browser.newContext({
            locale: "nl-NL",
            timezoneId: "Europe/Amsterdam",
            userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123 Safari/537.36",
            viewport: { width: 1366, height: 768 },
            deviceScaleFactor: 1,
            geolocation: { longitude: 5.1214, latitude: 52.0907 },
            permissions: ["geolocation"],
            ignoreHTTPSErrors: true
          });

          const page = await context.newPage();

          try {
            console.log("Opening Kruidvat...");

            await page.goto("https://www.kruidvat.nl", {
              waitUntil: "domcontentloaded",
              timeout: 90000
            });

            console.log("Title:", await page.title());

            await page.screenshot({ path: "kruidvat.png", fullPage: true });

            const html = await page.content();
            const fs = require("fs");
            fs.writeFileSync("kruidvat.html", html);

            console.log("Saved screenshot + HTML");

          } catch (err) {
            console.error("ERROR:", err);
          }

          await browser.close();
        })();
        EOF

    - name: Run Playwright script
      run: node test-kruidvat.js

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kruidvat-debug
        path: |
          kruidvat.png
          kruidvat.html
